<!-- Add this right after the control-panel div -->
<div class="status-panel">
    <h2>Processing Status</h2>
    <div class="status-items">
        <div class="status-item">
            <span class="status-label">Reference Photos:</span>
            <span id="refStatus" class="status-value">Not started</span>
        </div>
        <div class="status-item">
            <span class="status-label">Photo Collection:</span>
            <span id="photoStatus" class="status-value">Not started</span>
        </div>
        <div class="status-item">
            <span class="status-label">Messages:</span>
            <span id="messageStatus" class="status-value">Not started</span>
        </div>
    </div>
    <div class="progress-bar" id="totalProgress">
        <div class="progress-fill"></div>
        <span class="progress-text">0%</span>
    </div>
</div>

<style>
    .status-panel {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 5px;
    }
    .status-items {
        margin: 10px 0;
    }
    .status-item {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
    }
    .status-value {
        font-weight: bold;
    }
    .status-value.pending { color: #f0ad4e; }
    .status-value.processing { color: #5bc0de; }
    .status-value.complete { color: #5cb85c; }
    .status-value.error { color: #d9534f; }
    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f5f5f5;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin: 10px 0;
    }
    .progress-fill {
        height: 100%;
        background-color: #5cb85c;
        width: 0;
        transition: width 0.3s ease;
    }
    .progress-text {
        position: absolute;
        width: 100%;
        text-align: center;
        color: #333;
        line-height: 20px;
    }
</style>

<script>
    // Add this to your existing JavaScript
    async function checkProcessingStatus(jobId) {
        const statusEndpoint = `https://api.github.com/repos/YOUR_USERNAME/YOUR_REPO/actions/runs/${jobId}`;
        
        const updateStatus = (elementId, status, message) => {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-value ${status}`;
        };

        const updateProgress = (percent) => {
            const progressBar = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
        };

        try {
            const response = await fetch(statusEndpoint, {
                headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            const data = await response.json();
            
            switch(data.status) {
                case 'queued':
                    updateStatus('refStatus', 'pending', 'Queued...');
                    updateProgress(10);
                    break;
                case 'in_progress':
                    updateStatus('refStatus', 'processing', 'Processing...');
                    updateStatus('photoStatus', 'processing', 'Processing...');
                    updateProgress(50);
                    break;
                case 'completed':
                    if (data.conclusion === 'success') {
                        updateStatus('refStatus', 'complete', 'Complete');
                        updateStatus('photoStatus', 'complete', 'Complete');
                        updateStatus('messageStatus', 'complete', 'Complete');
                        updateProgress(100);
                        return true;
                    } else {
                        updateStatus('refStatus', 'error', 'Failed');
                        updateStatus('photoStatus', 'error', 'Failed');
                        updateStatus('messageStatus', 'error', 'Failed');
                        return true;
                    }
                    break;
            }
            
            // Continue checking if not complete
            setTimeout(() => checkProcessingStatus(jobId), 5000);
            return false;
            
        } catch (error) {
            console.error('Error checking status:', error);
            updateStatus('refStatus', 'error', 'Error checking status');
            return true;
        }
    }

    // Modify your processData function
    async function processData() {
        try {
            updateStatus('refStatus', 'pending', 'Starting...');
            updateStatus('photoStatus', 'pending', 'Waiting...');
            updateStatus('messageStatus', 'pending', 'Waiting...');
            updateProgress(0);

            // Your existing process code here...
            
            const response = await fetch('https://api.github.com/repos/Anshul-Boinepally/anshubot/dispatches', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    event_type: 'process_dataset',
                    client_payload: {
                        data: processedFiles
                    }
                })
            });

            if (response.ok) {
                const jobId = await getLatestJobId(); // You'll need to implement this
                checkProcessingStatus(jobId);
            } else {
                throw new Error('Failed to start processing');
            }

        } catch (error) {
            updateStatus('refStatus', 'error', 'Failed');
            updateStatus('photoStatus', 'error', 'Failed');
            updateStatus('messageStatus', 'error', 'Failed');
            console.error('Processing failed:', error);
        }
    }
</script>
